#!/usr/bin/env bash
set -euo pipefail

# Run FastAPI from repo root without cd hacks.
# Uses local venv: .venv

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$ROOT_DIR/.venv"

if [[ ! -d "$VENV_DIR" ]]; then
  echo "ERROR: venv not found at $VENV_DIR"
  echo "Create it: python3 -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt"
  exit 1
fi

# shellcheck disable=SC1091
source "$VENV_DIR/bin/activate"

HOST="${HOST:-127.0.0.1}"
PORT="${PORT:-8000}"
WORKERS="${WORKERS:-1}"
RELOAD="${RELOAD:-0}"

APP_IMPORT="astroprocessor.app.main:app"

cd "$ROOT_DIR"

if [[ "$RELOAD" == "1" ]]; then
  exec python -m uvicorn "$APP_IMPORT" \
    --host "$HOST" \
    --port "$PORT" \
    --reload
else
  exec python -m uvicorn "$APP_IMPORT" \
    --host "$HOST" \
    --port "$PORT" \
    --workers "$WORKERS"
fi
