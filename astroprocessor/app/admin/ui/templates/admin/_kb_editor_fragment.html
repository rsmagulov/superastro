{% if not frag %}
  <div class="kb-editor">
    <div class="kb-editor__header">
      <h3>Fragment not found</h3>
    </div>
  </div>
{% else %}

{% set meta = frag.meta or {} %}
{% set chunk_id = frag.chunk_id if frag.chunk_id is defined and frag.chunk_id is not none else meta.get('chunk_id') %}
{% set chunk_seq = frag.chunk_seq if frag.chunk_seq is defined and frag.chunk_seq is not none else meta.get('chunk_seq') %}
{% set char_start = frag.char_start if frag.char_start is defined and frag.char_start is not none else meta.get('char_start') %}
{% set char_end = frag.char_end if frag.char_end is defined and frag.char_end is not none else meta.get('char_end') %}

<div class="kb-editor">
  <div class="kb-editor__header">
    <div class="kb-editor__title">
      <div class="kb-hline">
        <strong>FRAGMENT #{{ frag.id }}</strong>
        <span class="mono">key={{ frag.key }}</span>
        <span class="pill pill-{{ frag.state }}">{{ frag.state }}</span>
      </div>

      <div class="kb-hline">
        <strong>CHUNK</strong>
        {% if chunk_id %}
          <a class="kb-link mono"
             href="#"
             hx-get="/admin/ui/kb/chunk/{{ chunk_id }}"
             hx-target="#editor_body"
             hx-swap="innerHTML">
            #{{ chunk_id }}
          </a>
        {% else %}
          <span class="mono">—</span>
        {% endif %}
        <span class="mono">seq={{ chunk_seq if chunk_seq is not none else '—' }}</span>
        <span class="mono">offsets={{ char_start if char_start is not none else '—' }}..{{ char_end if char_end is not none else '—' }}</span>
      </div>

      <div class="kb-hline small muted">
        topic={{ frag.topic_category }} · locale={{ frag.locale }}
      </div>
    </div>
  </div>

  <div class="kb-editor__body">
    <form hx-post="/admin/ui/kb/fragment/{{ frag.id }}/save" hx-target="#kb_save_status" hx-swap="innerHTML">
      <div class="kb-form-row">
        <label>State</label>
        <select name="state">
          {% for st in ['draft','needs_review','reviewed','annotated','validated','enabled','archived'] %}
            <option value="{{ st }}" {% if st == frag.state %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>

        <label class="kb-check">
          <input type="checkbox" name="requires_rewrite" {% if meta.get('requires_rewrite') %}checked{% endif %}/>
          requires_rewrite
        </label>
      </div>

      <label class="kb-label">Text</label>
      <textarea name="text" class="kb-textarea" rows="16">{{ frag.text }}</textarea>

      <details class="kb-details">
        <summary>meta_json (advanced)</summary>
        <textarea name="meta_json" class="kb-textarea mono" rows="8">{{ frag.meta_json }}</textarea>
      </details>

      <div class="kb-actions">
        <button type="submit" class="btn btn-primary">Save fragment</button>
        <div id="kb_save_status" class="kb-save-status"></div>
      </div>
    </form>
  </div>
</div>

{% endif %}
