{# app/admin/ui/templates/admin/items.html #}
{% extends "admin/_layout.html" %}
{% block content %}

<h2>Фрагменты</h2>
<div id="flash-area"></div>

<form id="filters" class="filters" method="get" action="/admin/ui/items">
  <input type="hidden" name="limit" value="{{ pagination.limit }}"/>
  <input type="hidden" name="offset" value="{{ pagination.offset }}"/>

  <label>Q:</label>
  <input name="q" value="{{ filters.q }}"/>

  <label>Locale:</label>
  <select name="locale">
    <option value="">(all)</option>
    {% for l in locales %}
      <option value="{{ l }}" {% if l==filters.locale %}selected{% endif %}>{{ l }}</option>
    {% endfor %}
  </select>

  <label>Topic:</label>
  <select name="topic_category">
    <option value="">(all)</option>
    {% for tc in topic_categories %}
      <option value="{{ tc }}" {% if tc==filters.topic_category %}selected{% endif %}>{{ tc }}</option>
    {% endfor %}
  </select>

  <label>Active:</label>
  <select name="is_active">
    <option value="">(all)</option>
    <option value="1" {% if filters.is_active=="1" %}selected{% endif %}>1</option>
    <option value="0" {% if filters.is_active=="0" %}selected{% endif %}>0</option>
  </select>

  {# ВАЖНО: не submit, чтобы не делать full page reload #}
  <button
    type="button"
    hx-get="/admin/ui/items/table"
    hx-include="#filters-form"
    hx-target="#items-table"
    hx-swap="innerHTML"
    onclick="document.querySelector('#filters-form input[name=offset]').value='0';"
  >Apply</button>
</form>

{% include "admin/_bulk_bar.html" %}

<div
  id="items-table"
  hx-get="/admin/ui/items/table"
  hx-trigger="load, itemsChanged from:body"
  hx-include="#filters-form"
  hx-target="#items-table"
  hx-swap="innerHTML"
>
  Loading...
</div>

<script>
  function selectedIds() {
    return Array.from(document.querySelectorAll('input.row-check:checked'))
      .map(x => x.value);
  }
</script>

<script>
document.body.addEventListener("change", (e) => {
  if (!e.target.matches("input.row-check")) return;
  const csv = selectedIds().join(",");
  const a = document.getElementById("bulk-ids-active");
  const t = document.getElementById("bulk-ids-tone");
  const c = document.getElementById("bulk-ids-topic");
  if (a) a.value = csv;
  if (t) t.value = csv;
  if (c) c.value = csv;
});
</script>


{% endblock %}
