{% extends "admin/_layout.html" %}

{% block content %}
<h1>Health / Status</h1>
<p class="muted">
  –ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π: –ë–î, –¥–æ–∫—É–º–µ–Ω—Ç—ã/—á–∞–Ω–∫–∏, FTS, –æ—á–µ—Ä–µ–¥–∏ –∏–º–ø–æ—Ä—Ç–∞ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏.
</p>

{% include "admin/_flash.html" %}

<div class="card">
  <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
    <h2 style="margin:0;">–°–æ—Å—Ç–æ—è–Ω–∏–µ</h2>
    <a class="btn" href="/admin/ui/health">üîÑ Refresh</a>
  </div>

  <div class="kv" style="margin-top:10px;">
    <div><b>DB:</b> <code>{{ db_snap.db_path }}</code></div>
    <div><b>DB exists:</b> {{ "yes" if db_snap.db_exists else "no" }}</div>
    <div><b>Docs total:</b> {{ db_snap.docs_total }}</div>
    <div><b>Chunks total:</b> {{ db_snap.chunks_total }}</div>
    <div>
      <b>FTS:</b>
      {% if db_snap.fts_ok %}
        <span class="badge ok">OK</span>
      {% else %}
        <span class="badge warn">NOT OK</span>
        <span class="muted">({{ db_snap.fts_error }})</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="card">
  <h2>–û—á–µ—Ä–µ–¥–∏ –∏–º–ø–æ—Ä—Ç–∞</h2>
  <div class="kv">
    <div><b>inbox:</b> <code>{{ inbox_dir }}</code></div>
    <div><b>files:</b> {{ inbox_count }}</div>
    <div><b>processed:</b> <code>{{ processed_dir }}</code></div>
    <div><b>files:</b> {{ processed_count }}</div>
    <div><b>failed:</b> <code>{{ failed_dir }}</code></div>
    <div><b>files:</b> {{ failed_count }}</div>
  </div>
</div>

<div class="card">
  <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∏–º–ø–æ—Ä—Ç</h2>
  {% if last_doc_name %}
    <div class="muted">–§–∞–π–ª: <code>{{ last_doc_name }}</code></div>
    <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn" href="/admin/ui/health/last_import">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏–º–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é</a>
    </div>
    <div class="box" style="margin-top:10px;">
      <div class="muted">Preview (–ø–µ—Ä–≤—ã–µ ~60 —Å—Ç—Ä–æ–∫):</div>
      <pre style="white-space:pre-wrap; max-height:280px; overflow:auto; margin:6px 0 0 0;">{{ last_doc_preview }}</pre>
    </div>
  {% else %}
    <div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö .md –≤ <code>knowledge/docs</code>.</div>
  {% endif %}
</div>

<div class="card">
  <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ (manifest)</h2>
  {% if manifest_errors and manifest_errors|length > 0 %}
    <div class="box">
      <table class="table">
        <thead>
          <tr>
            <th>ts</th>
            <th>status</th>
            <th>source</th>
            <th>error</th>
          </tr>
        </thead>
        <tbody>
          {% for e in manifest_errors %}
            <tr>
              <td class="mono">{{ e.ts }}</td>
              <td class="mono">{{ e.status }}</td>
              <td class="mono" style="max-width:320px; overflow:hidden; text-overflow:ellipsis;">{{ e.source }}</td>
              <td class="mono" style="max-width:520px; overflow:hidden; text-overflow:ellipsis;">{{ e.error }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">–û—à–∏–±–æ–∫ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–∏–ª–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç).</div>
  {% endif %}
</div>

{% endblock %}